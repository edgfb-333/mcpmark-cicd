name: Deployment Status Workflow

on:
  push:
    branches:
      - main

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
      previous_commit: ${{ steps.get-commits.outputs.previous_commit }}
      current_commit: ${{ steps.get-commits.outputs.current_commit }}
      package_version: ${{ steps.get-package-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint || echo "No lint script found, skipping..."

      - name: Run tests
        run: npm test || echo "No test script found, skipping..."

      - name: Get commit information
        id: get-commits
        run: |
          CURRENT_COMMIT=$(git rev-parse HEAD)
          PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "previous_commit=$PREVIOUS_COMMIT" >> $GITHUB_OUTPUT
          echo "Current commit: $CURRENT_COMMIT"
          echo "Previous commit: $PREVIOUS_COMMIT"

      - name: Get package version
        id: get-package-version
        run: |
          if [ -f package.json ]; then
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Package version: $VERSION"
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
            echo "No package.json found"
          fi

      - name: Create deployment tracking issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${{ steps.get-commits.outputs.current_commit }}`,
              labels: ['deployment', 'in-progress'],
              body: `## Deployment Tracking
              
              **Commit SHA:** ${{ steps.get-commits.outputs.current_commit }}
              **Previous Commit:** ${{ steps.get-commits.outputs.previous_commit }}
              **Package Version:** ${{ steps.get-package-version.outputs.version }}
              
              This issue tracks the deployment process.
              `
            });
            core.setOutput('issue_number', issue.data.number);
            console.log(`Created issue #${issue.data.number}`);

      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-issue.outputs.issue_number }},
              body: '‚úÖ Pre-deployment checks completed'
            });

  rollback-preparation:
    name: rollback-preparation
    needs: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      artifact_name: ${{ steps.create-artifacts.outputs.artifact_name }}
      checksum: ${{ steps.create-artifacts.outputs.checksum }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create rollback directory
        run: |
          mkdir -p rollback-artifacts
          echo "Created rollback-artifacts directory"

      - name: Create rollback script
        run: |
          cat > rollback-artifacts/rollback.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "Starting rollback process..."
          
          # Error handling
          handle_error() {
            echo "‚ùå Error occurred at line $1"
            exit 1
          }
          trap 'handle_error $LINENO' ERR
          
          # Check if we're in a git repository
          if ! git rev-parse --git-dir > /dev/null 2>&1; then
            echo "‚ùå Not in a git repository"
            exit 1
          fi
          
          # Get the target commit
          TARGET_COMMIT="${1:-}"
          if [ -z "$TARGET_COMMIT" ]; then
            echo "‚ùå Target commit SHA required"
            echo "Usage: ./rollback.sh <commit-sha>"
            exit 1
          fi
          
          echo "üîÑ Rolling back to commit: $TARGET_COMMIT"
          
          # Stash current changes
          echo "üì¶ Stashing current changes..."
          git stash push -m "Pre-rollback stash"
          
          # Checkout target commit
          echo "üîÄ Checking out target commit..."
          git checkout "$TARGET_COMMIT"
          
          # Restore dependencies
          if [ -f package.json ]; then
            echo "üì• Installing dependencies..."
            npm ci
          fi
          
          echo "‚úÖ Rollback completed successfully!"
          echo "Current commit: $(git rev-parse HEAD)"
          EOF
          chmod +x rollback-artifacts/rollback.sh
          echo "Created rollback script"

      - name: Backup configuration files
        run: |
          mkdir -p rollback-artifacts/config-backup
          if [ -f package.json ]; then
            cp package.json rollback-artifacts/config-backup/
            echo "Backed up package.json"
          fi
          if [ -f package-lock.json ]; then
            cp package-lock.json rollback-artifacts/config-backup/
            echo "Backed up package-lock.json"
          fi
          if [ -f .env.example ]; then
            cp .env.example rollback-artifacts/config-backup/
            echo "Backed up .env.example"
          fi
          if [ -f .env ]; then
            cp .env rollback-artifacts/config-backup/
            echo "Backed up .env"
          fi

      - name: Create dependency verification script
        run: |
          cat > rollback-artifacts/verify-dependencies.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "Verifying dependencies..."
          
          if [ ! -f package.json ]; then
            echo "‚ùå package.json not found"
            exit 1
          fi
          
          echo "‚úÖ package.json found"
          
          if [ ! -f package-lock.json ]; then
            echo "‚ö†Ô∏è  package-lock.json not found"
          else
            echo "‚úÖ package-lock.json found"
          fi
          
          # Check Node.js version
          if command -v node &> /dev/null; then
            NODE_VERSION=$(node -v)
            echo "‚úÖ Node.js version: $NODE_VERSION"
          else
            echo "‚ùå Node.js not installed"
            exit 1
          fi
          
          # Check npm version
          if command -v npm &> /dev/null; then
            NPM_VERSION=$(npm -v)
            echo "‚úÖ npm version: $NPM_VERSION"
          else
            echo "‚ùå npm not installed"
            exit 1
          fi
          
          echo "‚úÖ Dependency verification completed"
          EOF
          chmod +x rollback-artifacts/verify-dependencies.sh
          echo "Created dependency verification script"

      - name: Create rollback documentation
        run: |
          cat > rollback-artifacts/ROLLBACK_GUIDE.md << 'EOF'
          # Rollback Guide
          
          This guide provides step-by-step instructions for rolling back deployments.
          
          ## Prerequisites
          
          - Git installed and configured
          - Node.js and npm installed
          - Access to the repository
          
          ## Quick Rollback
          
          1. Navigate to the repository directory
          2. Run the rollback script:
             ```bash
             ./rollback.sh <commit-sha>
             ```
          
          ## Manual Rollback Steps
          
          1. **Stash current changes**
             ```bash
             git stash push -m "Pre-rollback stash"
             ```
          
          2. **Checkout the target commit**
             ```bash
             git checkout <commit-sha>
             ```
          
          3. **Install dependencies**
             ```bash
             npm ci
             ```
          
          4. **Verify the rollback**
             ```bash
             npm test
             ```
          
          5. **Start the application**
             ```bash
             npm start
             ```
          
          ## Verification
          
          After rollback, verify:
          - Application starts successfully
          - All tests pass
          - No errors in logs
          - Expected functionality works
          
          ## Troubleshooting
          
          ### Rollback fails
          - Check git status for conflicts
          - Ensure you have the correct commit SHA
          - Verify network connectivity
          
          ### Dependencies fail to install
          - Clear npm cache: `npm cache clean --force`
          - Delete node_modules and try again
          - Check Node.js version compatibility
          
          ## Contact
          
          For issues or questions, contact the DevOps team.
          EOF
          echo "Created rollback documentation"

      - name: Create checksums file
        id: create-artifacts
        run: |
          cd rollback-artifacts
          
          # Generate SHA256 checksums for all files
          sha256sum * > checksums.txt
          
          # Create a checksum for the entire package
          find . -type f -exec sha256sum {} \; | sort | sha256sum | awk '{print $1}' > package-checksum.txt
          CHECKSUM=$(cat package-checksum.txt)
          
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          
          ARTIFACT_NAME="rollback-package-${{ needs.pre-deployment.outputs.current_commit }}"
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          
          echo "Generated checksums"
          echo "Package checksum: $CHECKSUM"
          echo "Artifact name: $ARTIFACT_NAME"

      - name: Create rollback package
        run: |
          cd rollback-artifacts
          tar -czf ../rollback-package.tar.gz .
          echo "Created rollback package"

      - name: Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rollback-package-${{ needs.pre-deployment.outputs.current_commit }}
          path: rollback-package.tar.gz
          retention-days: 30

      - name: Post rollback preparation comment
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## üîÑ Rollback Plan Ready
            
            **Previous Commit:** ${{ needs.pre-deployment.outputs.previous_commit }}
            **Current Commit:** ${{ needs.pre-deployment.outputs.current_commit }}
            **Package Version:** ${{ needs.pre-deployment.outputs.package_version }}
            **Artifact:** rollback-package-${{ needs.pre-deployment.outputs.current_commit }}
            
            ### Rollback Components
            ‚úÖ Rollback script created
            ‚úÖ Configuration backup completed
            ‚úÖ Dependency verification script ready
            ‚úÖ Rollback documentation generated
            ‚úÖ Checksums calculated
            
            ### Quick Rollback Command
            \`\`\`bash
            # Download and extract rollback package
            gh run download <run-id> -n rollback-package-${{ needs.pre-deployment.outputs.current_commit }}
            tar -xzf rollback-package.tar.gz
            
            # Execute rollback
            ./rollback.sh ${{ needs.pre-deployment.outputs.previous_commit }}
            \`\`\`
            
            ### Verification Status
            - Rollback script created: true
            - Configuration backup: true
            - Dependency verification: true
            - Documentation: true
            - Checksums: true
            
            **SHA256:** ${{ steps.create-artifacts.outputs.checksum }}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              body: commentBody
            });

  post-deployment:
    name: post-deployment
    needs: rollback-preparation
    runs-on: ubuntu-latest
    steps:
      - name: Update deployment issue labels
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            
            // Remove 'in-progress' label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'in-progress'
              });
            } catch (error) {
              console.log('Label in-progress not found or already removed');
            }
            
            // Add 'completed' label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['completed']
            });

      - name: Post final deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## ‚úÖ Deployment Completed Successfully
            
            **Deployment Summary:**
            - **Commit:** ${{ needs.pre-deployment.outputs.current_commit }}
            - **Previous Commit:** ${{ needs.pre-deployment.outputs.previous_commit }}
            - **Package Version:** ${{ needs.pre-deployment.outputs.package_version }}
            
            **Rollback Artifact:**
            - **Artifact Name:** ${{ needs.rollback-preparation.outputs.artifact_name }}
            - **SHA256 Checksum:** ${{ needs.rollback-preparation.outputs.checksum }}
            - **Retention:** 30 days
            
            All deployment checks passed successfully. Rollback artifacts are available if needed.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              body: commentBody
            });

      - name: Close deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              state: 'closed'
            });
